#!/usr/bin/env sh
set -eu

# Convenience symlink: ~/.dotfiles -> chezmoi source dir
TARGET="{{ .chezmoi.homeDir }}/.dotfiles"
SOURCE="{{ .chezmoi.sourceDir }}"
if [ ! -e "$TARGET" ]; then
  ln -s "$SOURCE" "$TARGET"
fi
[ "{{ .chezmoi.os }}" = "darwin" ] || exit 0

if ! command -v brew >/dev/null 2>&1; then
  echo "brew not found. Install Homebrew first: https://brew.sh/"
  exit 1
fi

cd "{{ .chezmoi.sourceDir }}"

# Install base Brewfile first
if [ -f Brewfile ]; then
  echo "➡️  Installing base packages from Brewfile..."
  brew bundle --file Brewfile --no-lock || brew bundle --file Brewfile
else
  echo "ℹ️  No Brewfile found; skipping base packages."
fi

# Install extra packages if Brewfile.extra exists
if [ -f Brewfile.extra ]; then
  echo "➡️  Installing extra packages from Brewfile.extra..."
  brew bundle --file Brewfile.extra --no-lock || brew bundle --file Brewfile.extra
else
  echo "ℹ️  No Brewfile.extra found; skipping extra packages."
fi
